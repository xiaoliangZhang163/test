# 函件系统自主学习之下载（导出功能实现）

## 第一步 获取前端传参

1.ID: id  2.签章审核ID:  qzshid  3. 类型：pltype

```java
String id = request.getParameter("id");
String qzshid = request.getParameter("qzshid");
String pltype = request.getParameter("pltype");
commonService.clDownload(id, qzshid, pltype, response);
```

## 第二步 根据参数得到要导出的信息（名称，路径）

1.根据id查询“申请表”获得函件类型 案件名称 边控函件类型 限制出境函件类型信息。

2.新建List<Map>来存储要导出的信息。

3.根据类型是否为文书函件分类

​	3.1若为文书函件

​		3.1.1.根据申请id查询“审批前表”获取审批前材料路径信息

​		a.若路径为空：根据函件类型确定函件模板

```

```

```java
Map<String, String> spqMap = new HashMap<>();
Integer hjlx = sqxx.get("bkhjlx") != null ? (Integer) sqxx.get("bkhjlx") : (Integer) sqxx.get("xzcjhjlx");
HjmbEntity hjmb = hjscMapper.getLjByHjlx(hjlx, Constants.SF_S);
String filename = hjmb.getHjmc();spqMap.put("lj", lj);
spqMap.put("filename", "审批表" + File.separator + filename);
list.add(spqMap);
```

​	b.若边控函件类型 为 函件类型-实施边控的函

​	确定边控对象通知书或采取限制出境措施决定书

```java

//边控对象通知书
List<Map<String, String>> bxdxList = commonMapper.getBkdx(id);
if (bxdxList != null) {
	addList(bxdxList, list, "边控对象通知书");
}
//采取限制出境措施决定书
List<Map<String, String>> jdsList = commonMapper.getCqxzcj(id);
if (jdsList != null) {
	addList(jdsList, list, "采取限制出境措施决定书");
}
```



c.根据限制处境函件类型 

确定 限制出境报备通知书 或 撤销报备通知书

```java
if (Constants.HJLX_CQXZCJ.equals(sqxx.get("xzcjhjlx"))) {
    //限制出境报备通知书
	List<Map<String, String>> tzsList = commonMapper.getFdbpzcj(id);
    if (tzsList != null) {
    	addList(tzsList, list, "限制出境报备通知书");
    }
} else if (Constants.HJLX_CXBBDH.equals(sqxx.get("xzcjhjlx"))) {
    //撤销报备通知书
    List<Map<String, String>> tzsList = commonMapper.getFdbpzcj(id);
    if (tzsList != null) {
         addList(tzsList, list, "撤销报备通知书");
     }
}
```



d.根据id查函件表 并遍历结果 根据结果的函件类型字段得到文件的路径和名称。

3.1 若非文书函件

判断同3.0

## 第三步：确定导出文件名称和编码

```java
String zipFileName = null;
if (ObjectUtils.isNotEmpty(sqxx.get("ajmc"))) {
	zipFileName = sqxx.get("ajmc") + "";

} else {
	zipFileName = LetterUtils.cxlxDzdmFy(dzdmFy, (Integer) sqxx.get("hjlx"));
}
	String zipname = zipFileName + "-" + CommonUtils.format(new Date(), "yyyy-MM-dd") + ".rar";
	String name = "";
try {
	name = URLEncoder.encode(zipname, "utf-8");
} catch (UnsupportedEncodingException e1) {
	logger.error("文件名转码异常", e1);
}

```

## 第四步 ：设置头文件

```java
 response.setHeader("Content-Disposition", "attachment; filename=\"" + name + "\";filename*=UTF-8''" + name);
 response.setContentType("application/octet-stream;charset=UTF-8");
```



## 第五步 ：文件导出

```java
 try (ZipOutputStream zos = new ZipOutputStream(response.getOutputStream())) {
	for (int i = 0; i < list.size(); i++) {
    	Map map = list.get(i);
        ZipEntry zipEntry = new ZipEntry((String) map.get("filename"));
        try {
        	zos.putNextEntry(zipEntry);
       } catch (ZipException e) {
         	String filename = (String) map.get("filename");
            filename = filename.substring(0, filename.lastIndexOf('.')) + "(" + i + ")" + filename.substring(filename.lastIndexOf('.'), filename.length());
            zipEntry = new ZipEntry(filename);
            zos.putNextEntry(zipEntry);
       }
       	        zos.write(IOUtils.toByteArray(minioUtils.getInputStream((String)map.get("lj")).get()));
  }
  if ("wshj".equalsIgnoreCase(pltype) && 	    Constants.HJLX_CQXZCJ.equals(sqxx.get("xzcjhjlx"))) {
                ZipEntry zipEntry = new ZipEntry("不准出境人员表.mdb");
                zos.putNextEntry(zipEntry);
                zos.write(bkhjsqService.getAccessBytes(id));
            }
        } catch (IOException | ClassNotFoundException e) {
            logger.error("获取输出流异常", e);
        }
```

